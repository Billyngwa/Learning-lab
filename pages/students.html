<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://kit.fontawesome.com/a14b3ad818.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../styles/index.css">
</head>

<body class="dashboard-body">
    <section class="dashboard">
        <main>
            <div class="logo">
                <img src="../images/logo.png" alt="Hero Image">
            </div>
            <nav class="sidebar">
                <ul>
                    <li >
                        <a href="../pages/dashboard.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
                    </li>
                    <li>
                        <a href="../pages/courses.html"><i class="fa-solid fa-book"></i> My Courses</a>
                    </li>
                    <li>
                        <a href="../pages/mentors.html"><i class="fa-solid fa-chalkboard-user"></i> Mentors</a>
                    </li>
                    <li class="active">
                        <a href="../pages/students.html"><i class="fa-solid fa-user-graduate"></i> Students</a>
                    </li>
                    <li>
                        <a href="../pages/analytics.html"><i class="fa-solid fa-chart-line"></i> Analytics</a>
                    </li>
                    <li>
                        <a href="../pages/forum.html"><i class="fa-solid fa-comments"></i> Forum</a>
                    </li>
                    <li>
                        <div class="upgrade-section">
                            <h1>Upgrade to Pro</h1>
                            <p>Get access to additional features</p>
                            <button>Upgrade</button>
                        </div>
                    </li>
                    <li>
                        <a href="../pages/about.html"><i class="fa-solid fa-gear"></i> Settings</a>
                    </li>
                    <li>
                        <a href="../pages/about.html"><i class="fa-solid fa-circle-question"></i> Help</a>
                    </li>
                    <li>
                        <a href="#" id="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
                    </li>
                </ul>
            </nav>
        </main>
        <section class="dashboard-content">
            <nav>
                <h1>
                   Students
                </h1>
                <ul>
                    <li class="search-bar">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input class="search" type="search" placeholder="Search courses...">
                    </li>
                    <li class="notification">
                        <i class="fa-solid fa-bell"></i>
                        <span class="notification-count">3</span>
                    </li>
                    <li class="user-profile">
                        <img src="../images/logo.png" alt="Profile" class="profile-image">
                        <span class="username">John Doe</span>
                    </li>
                </ul>
            </nav>
           <section class="students-in-database">

           </section>
        </section>
    </section>
    <footer class="bg-teal-600 text-orange-100 py-4 text-center shadow-inner">
        &copy; 2025 Learning Lab. All rights reserved.
    </footer>

    <script type="module">
        import { auth, db } from "../js/firebase-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { updateUserProfile, handleLogout } from "../js/dashboard.js";
        
        // DOM Elements
        const studentsContainer = document.querySelector('.students-in-database');
        
        // Check authentication and admin status
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, update profile info
                    updateUserProfile(user);
                    
                    // Load students data
                    loadStudents();
                } else {
                    // No user is signed in, redirect to login
                    window.location.href = './login.html';
                }
            });
            
            // Set up logout button
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });
        });
        
        // Function to load all students from Firestore
        async function loadStudents() {
            try {
                // Show loading state
                studentsContainer.innerHTML = '<div class="loading">Loading students data...</div>';
                
                // Get all users from the "users" collection
                const querySnapshot = await getDocs(collection(db, "users"));
                
                // Check if we have any students
                if (querySnapshot.empty) {
                    studentsContainer.innerHTML = '<div class="no-data">No students found in the database.</div>';
                    return;
                }
                
                // Create HTML for students table
                let tableHTML = `
                    <div class="students-controls">
                        <h2>All Students</h2>
                        <div class="controls">
                            <button class="add-student">Add New Student</button>
                            <div class="filter-sort">
                                <select id="sort-students">
                                    <option value="name-asc">Name (A-Z)</option>
                                    <option value="name-desc">Name (Z-A)</option>
                                    <option value="date-asc">Registration Date (Oldest)</option>
                                    <option value="date-desc">Registration Date (Newest)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="students-table-container">
                        <table class="students-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Registration Date</th>
                                    <th>Active Courses</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add each student to the table
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    const date = student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    const coursesCount = student.activeCourses ? student.activeCourses.length : 0;
                    
                    tableHTML += `
                        <tr data-id="${doc.id}">
                            <td data-label="Name">${student.fullName || 'No Name'}</td>
                            <td data-label="Email">${student.email || 'No Email'}</td>
                            <td data-label="Phone">${student.phone || 'No Phone'}</td>
                            <td data-label="Registration Date">${date}</td>
                            <td data-label="Active Courses">${coursesCount}</td>
                            <td class="actions" data-label="Actions">
                                <button class="view-student" title="View Details"><i class="fas fa-eye"></i></button>
                                <button class="edit-student" title="Edit Student"><i class="fas fa-edit"></i></button>
                                <button class="delete-student" title="Delete Student"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                // Close the table
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add the table to the container
                studentsContainer.innerHTML = tableHTML;
                
                // Add event listeners for the action buttons
                setupStudentActions();
                
            } catch (error) {
                console.error("Error loading students:", error);
                studentsContainer.innerHTML = `<div class="error">Error loading students: ${error.message}</div>`;
            }
        }
        
        // Set up event listeners for student actions
        function setupStudentActions() {
            // View student details
            document.querySelectorAll('.view-student').forEach(button => {
                button.addEventListener('click', (e) => {
                    const studentId = e.target.closest('tr').dataset.id;
                    console.log("View student:", studentId);
                    // Implement view student functionality
                });
            });
            
            // Edit student
            document.querySelectorAll('.edit-student').forEach(button => {
                button.addEventListener('click', (e) => {
                    const studentId = e.target.closest('tr').dataset.id;
                    console.log("Edit student:", studentId);
                    // Implement edit student functionality
                });
            });
            
            // Delete student
            document.querySelectorAll('.delete-student').forEach(button => {
                button.addEventListener('click', (e) => {
                    const studentId = e.target.closest('tr').dataset.id;
                    const studentRow = e.target.closest('tr');
                    const studentName = studentRow.querySelector('td:first-child').textContent;
                    
                    if (confirm(`Are you sure you want to delete student: ${studentName}?`)) {
                        console.log("Delete student:", studentId);
                        // Implement delete student functionality
                    }
                });
            });
            
            // Add new student button
            const addButton = document.querySelector('.add-student');
            if (addButton) {
                addButton.addEventListener('click', () => {
                    console.log("Add new student");
                    // Implement add new student functionality
                });
            }
            
            // Sort functionality
            const sortSelect = document.getElementById('sort-students');
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    console.log("Sort students by:", sortSelect.value);
                    // Implement sort functionality
                });
            }
        }
    </script>
</body>

</html>